/*!
* Data Aquarium Framework  - Universal "Code" Input
* Copyright 2024 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function p(n,t){var i=t.getValue();n._dataView._editRow[n.Index]=i}function h(n){var t=n.tagged(/\binput\-code\-language\-(.+?)(\s|$)/);return t=t?t[1]:"text",t=t.match(/^\-*(.+?)\-*$/),t?t[1].replace(/\-+/g,""):null}function w(n,t){u={icons:n.icons,categories:{}};n.icons.forEach(n=>{var r=n.categories[0]||"Unknown",f=r.toLowerCase(),t=u.categories[f];t||(r.length==2&&(r=r.toUpperCase()),t=u.categories[f]={id:f,name:i.prettyText(r,!0).replace(/\s*\u0026\s*/," & "),popularity:0,icons:[],iconMap:{}});t.iconMap[n.name]||(t.iconMap[n.name]=!0,t.icons.push(n),t.popularity+=n.popularity)});var r=['<div class="app-material-symbols-menu app-has-scrollbars" tabindex="1">'];c(u,r,!0);r.push('<section class="app-query-result"><\/section>');r.push("<\/div>");o=r.join("\n");i.getScript("~/css/daf/input-code.[min].css").then(()=>t.trigger("vclick"))}function c(n,t,i){var r=[];for(var u in n.categories)r.push(n.categories[u]);r.sort((n,t)=>n.popularity>t.popularity?-1:n.popularity<t.popularity?1:0);r.forEach(n=>{i&&t.push(`<section data-category="${n.id}"><h1>${n.name}</h1>`),t.push('<div class="app-icon-list">'),n.icons.forEach(n=>t.push(`<span class="app-symbol-button" data-icon="${n.name}"><i class="material-icon">${n.name}</i><span class="app-text">${n.name.replace(/\_/g," ")}</span></span> `)),t.push("<\/div>"),i&&t.push("<\/section>")})}function b(n,t){var e=0,f={},i=[],o;t=t.toLowerCase().replace(/\s+/g,"_");u.icons.forEach(n=>{var r=n.name;r.match(t)?r in f||(i.push(n),f[r]=!0,e++):n.tags.forEach(u=>{!u.startsWith(t)||r in f||(i.push(n),f[r]=!0,e++)})});i=i.sort((n,t)=>n.popularity>t.popularity?-1:n.popularity<t.popularity?1:0);o=[];c({categories:{result:{icons:i}}},o,!1);n.find(".app-query-result").html(o.join(""));n.toggleClass("app-query",e>0).scrollTop(0);setTimeout(()=>r.execute({category:null}))}function l(n,t){var r=n.field;i.survey({text:n.text,text2:n.text2,values:{code:t},topics:[{wrap:!0,questions:n.questions}],layout:n.layout,options:{contentStub:!1,materialIcon:n.icon,layout:n.layout,modal:{fitContent:!0,always:!0,max:n.max},discardChangesPrompt:n.discardChangesPrompt!=!1},calculate:n.calculate,submitText:v.Apply,submit:k,context:{field:n.field}})}function k(t){var u=t.survey.context.field,i=t.dataView,f=i.data();i.discard();n.goBack(()=>{r.execute({field:u.Name,value:f.code})})}function a(n){return n&&(n.match(/^material-icon-/)&&(n=n.substring(14)),n=n.replace(/\W/g,"_").toLowerCase()),n}var i=$app,r=i.input,n=i.touch,d=n.settings,e=Web.DataViewResources,v=e.Mobile,u,o,s,t=i.html,g=t.tag,nt=t.div,tt=t.span,it=t.$tag,rt=t.$p,y=t.$div,f=t.$span,ut=t.$a,ft=t.$i,et=t.$li,ot=t.$ul;r.methods.code={_init:function(t,r,u,o){function tt(){var n=CodeMirror(d[0],{lineNumbers:!0,tabSize:4,matchBrackets:!0,readOnly:!1,mode:l,scrollbarStyle:"simple",value:k});n.setOption("indentUnit",4);d.find(".CodeMirror").height(v);n.setSize(null,null);s.data("CodeMirror",n);n.on("change",()=>{clearTimeout(s.data("cmSaveTimeout")),s.data("cmSaveTimeout",setTimeout(p,250,t,n))});s.data("setFocus")&&n.focus()}var c=o.parent(),s=c.parent(),k,d,v,it=h(t),g,w,nt,b,l;if(it=="materialsymbols"&&(g=s.find(".app-value-icon"),g.length||(s.addClass("app-has-value-icon"),g=f("app-value-icon").appendTo(s)),g.text(r?a(r):"")),t._dataView.editing())if(t.tagged("input-code-prompt"))w=s.find(".app-data-input-button"),w.length||(w=f("app-data-input-button").attr("data-title",e.Actions.Scopes.Grid.Edit.HeaderText),f("app-caret").appendTo(w),w.insertBefore(c.hide())),s.addClass("app-has-input-button").attr("data-input",typeof r=="string"&&r.match(/[\r\n]/)?"none":"text");else{c.prev().hide();s.attr("data-input","code").removeClass("app-null");d=y("app-input-code-container").insertAfter(c);v=c.height();v||(nt=n.screen(),v=nt.isVirtual?Math.ceil(nt.height*.45):"45vh");b=getComputedStyle(o[0]).width;(b==="0px"||b=="100%")&&(b="");d.css("width",b).height(v);c.hide();l="text/plain";switch(it){case"javascript":l="text/javascript";break;case"csharp":l="text/x-csharp";break;case"sql":l="text/x-sql";break;case"html":l={name:"htmlmixed",scriptTypes:[{matches:/\/x-handlebars-template|\/x-mustache/i,mode:null}]}}k=r;k==null&&(k="");typeof CodeMirror!="undefined"?tt():i.getScript("~/js/lib/codemirror.min.js",{also:["~/js/lib/codemirror.min.css","~/css/daf/input-code.[min].css"],then:tt})}else c.hide()},render:function(){},focus:function(t){var u=t.data("CodeMirror"),i;return u?u.focus():t.data("setFocus",!0),i=r.elementToField(t),i&&n.saveLastFocusedField(i),!0},click:function(){},blur:function(){},setup:function(){},dispose:function(n){var t=n.data("CodeMirror");t&&(clearTimeout(n.data("cmSaveTimeout")),t.off("change"),t.getWrapperElement().remove())}};$(document).on("vclick",'[data-input-enhancement="code"] .app-data-input-button',t=>{var f=$(t.target),d=f.data("settingFocus"),e,y,s,p,b,k;if(f.removeData("settingFocus"),f.closest(".app-has-focus,.app-was-focused").length){if(e=r.elementToField(f),e&&(y=h(e),y)){var c=f.closest(".app-propgrid"),i={text:c.length?`${c.find(".app-selector-target .app-text").text()}`:!1,text2:c.length?`${$app.prettyText(c.find(".app-selector-target .app-muted").text())}`:!1,questions:[{name:"code",field:e,label:c.length?`${c.find(".app-infopane .app-title .app-text").text()}`:e.HeaderText,options:{spellCheck:!1}}],field:e},v="subject";switch(y){case"javascript":v="javascript";break;case"sql":v="database";break;case"html":v="code";break;case"materialsymbols":v="font_download";break;case"dataformatstring":v="numbers"}if(i.icon=v,s=e._dataView.fieldValue(e.Name),y=="materialsymbols")if(u){typeof s=="string"&&(s=a(s));i.layout=`
<div data-layout="form" data-layout-size="tn" data-input-container="survey1" data-state="write">
<div  data-container="simple" data-wrap="true" data-header-text="none">
<div data-container="row" data-merge="true">
<span data-control="label" data-field="code" style="font-size:1em"></span>
<div style="display:flex;justify-content:space-between">
<span data-control="field" data-field="code" data-notify="materialsymbolchanged.app" style="max-width:250px;min-width:250px"></span>
<span data-control="field" data-field="category" style="min-width:0;margin-right:24px"></span>
</div>
</div>
</div>${o}
</div>`;i.max="md";i.questions[0].placeholder="search for an icon";p=[];for(b in u.categories)k=u.categories[b],p.push({value:b,text:k.name});p=p.sort((n,t)=>n.text<t.text?-1:n.text>t.text?1:0);i.questions.push({name:"category",placeholder:"category",items:{list:p,targetController2:"basket"},options:{lookup:{nullValue:!1,openOnTap:!0}},causesCalculate:!0});i.discardChangesPrompt=!1;$(document).one("pageready.app",()=>{var i=n.activePage(".app-material-symbols-menu"),t;s&&(t=i.find(`[data-icon="${s}"]`),t.length&&t.addClass("app-selected")[0].scrollIntoView({block:"center"}))});i.calculate="materialsymbolscalculate.app";l(i,s)}else fetch(n.studio()+"/js/lib/material-symbols-catalog.json").then(n=>n.json()).then(n=>{w(n,f)}).catch(()=>{n.notify("Material Symbols are not available.")});else i.questions[0].options.inputCode={language:y},l(i,s)}return!1}if(d)return!1;f.data("settingFocus",!0);setTimeout(()=>f.trigger("vclick"),32)}).on("vclick",'[data-input-enhancement="code"][data-input="none"] .app-control-inner',t=>{var i=$(t.target);if(n.dblClick(i))return i.closest("[data-input]").find(".app-data-input-button").trigger("vclick"),!1}).on("fullscreen.app",()=>{n.activePage(".CodeMirror").each(function(){var n=$(this).closest("[data-input]").data("CodeMirror");n&&n.setSize(null,null)})}).on("vclick",".app-material-symbols-menu .app-symbol-button",function(n){var u=$(n.target).closest(".app-material-symbols-menu"),t,i;return u.find(".app-selected").removeClass("app-selected"),t=$(n.target).closest("[data-icon]"),i=t.attr("data-icon"),u.find(`[data-icon="${i}"]`).addClass("app-selected"),t[0].scrollIntoView({block:"nearest",behavior:"smooth"}),r.execute({code:i}),r.focus({field:"code"}),!1}).on("materialsymbolchanged.app",t=>{var i=t.inputData.value.trim(),u=n.activePage(".app-material-symbols-menu");clearTimeout(s);i.length?s=setTimeout(b,350,u,i):(u.removeClass("app-query").scrollTop(0).find(".app-selected").removeClass("app-selected"),r.execute({category:null}))}).on("materialsymbolscalculate.app",t=>{var o=t.dataView.data(),r,f,e,s,u,h,c;o.category&&(r=n.activePage(".app-material-symbols-menu"),f=r.removeClass("app-query").find(`[data-category="${o.category}"]`),f.length&&(e=f.find(".app-icon-list"),e[0].scrollIntoView({block:"start",behavior:"instant"}),r.scrollTop(s),s=r.scrollTop()-4,u=e.find(".app-selected"),u.length&&(h=i.clientRect(r),c=i.clientRect(u),c.bottom>h.bottom&&u[0].scrollIntoView({block:"center",behavior:"instant"})),setTimeout(()=>r.focus(),100)))})})()